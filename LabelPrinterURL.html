<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Printer (78x50mm) + QR</title>
    <!-- Import Font Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import QRCode.js ·ûü·ûò·üí·ûö·û∂·ûî·üã·ûî·ûÑ·üí·ûÄ·ûæ·ûè QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Kantumruy Pro"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6366f1', /* Indigo 500 */
                        secondary: '#0ea5e9', /* Sky 500 */
                        success: '#10b981', /* Emerald 500 */
                        danger: '#f43f5e', /* Rose 500 */
                        warning: '#f59e0b', /* Amber 500 */
                        dark: '#0f172a',    /* Slate 900 */
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --page-width: 78mm;
            --page-height: 50mm;
            /* Margin Variables */
            --page-margin-top: 0mm;
            --page-margin-right: 0mm;
            --page-margin-bottom: 0mm;
            --page-margin-left: 0mm;
            
            /* Border Line Margins */
            --border-margin-left: 0mm;
            --border-margin-right: 2mm; /* Default padding-left */
        }

        html, body {
            box-sizing: border-box;
            font-family: 'Kantumruy Pro', sans-serif;
            color: #f1f5f9;
        }
        *, *:before, *:after { box-sizing: inherit; }

        .hidden { display: none !important; }

        /* --- LABEL STYLES --- */
        .label-page {
            width: var(--page-width); 
            height: var(--page-height);
            background-color: white; 
            
            /* Apply Dynamic Margins */
            padding-top: calc(1mm + var(--page-margin-top));
            padding-right: calc(3mm + var(--page-margin-right)); 
            padding-bottom: calc(1mm + var(--page-margin-bottom)); 
            padding-left: calc(3mm + var(--page-margin-left));

            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 8pt;
            line-height: 1.1;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            color: #000;
            flex-shrink: 0;
        }

        /* QR Label Fixes */
        #qr-label-container { 
            align-items: center; justify-content: center; text-align: center; flex-direction: column; 
            padding: 4mm;
            /* Margins for QR page */
            padding-top: calc(4mm + var(--page-margin-top));
            padding-right: calc(4mm + var(--page-margin-right));
            padding-bottom: calc(4mm + var(--page-margin-bottom));
            padding-left: calc(4mm + var(--page-margin-left));
            word-wrap: break-word; overflow-wrap: break-word;
        }

        .label-header {
            /* Removed border-bottom here, using separate div */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7pt; 
            font-weight: 500; 
            padding-top: 1mm; 
            padding-bottom: 0.5mm; 
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
        }

        /* Explicit Header Separator Line */
        .header-separator {
            width: 100%;
            height: 1.5px; /* Thickness */
            background-color: #000; /* Color */
            margin-bottom: 1mm;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            flex-grow: 1;
            gap: 1mm;
            padding-top: 0;
            padding-bottom: 0;
            width: 100%;
        }

        .info-block { flex: 1; display: flex; flex-direction: column; justify-content: start; }
        .info-block.right {
            text-align: right;
            border-left: 1px solid #000; 
            padding-left: 2mm;
            width: 40%;
        }
        .info-block.left { width: 60%; padding-right: 1mm; }

        .small-text { font-size: 7pt; font-weight: 500; color: #333; margin-bottom: 0; }
        .big-text { font-size: 10pt; font-weight: 700; line-height: 1.1; } 
        #label-phone { font-size: 11pt; font-weight: 700; line-height: 1.1; }
        #label-location { font-size: 10pt; font-weight: 700; line-height: 1.1; } 
        .data-text { font-size: 9pt; font-weight: 700; line-height: 1.1; } 
        
        /* Updated Shop Name Style: Right aligned, small, not bold */
        #label-page-name { 
            font-size: 7.5pt; 
            font-weight: 700; 
            margin-bottom: 1mm; 
            text-align: left; /* Changed to Left */
        }

        .compact-mt { margin-top: 0.5mm; } 

        .total-box {
            background-color: #f1f5f9;
            color: #000;
            padding: 0.5mm;
            border-radius: 0.125rem;
            font-weight: 700;
            font-size: 10pt;
            margin-top: 0.5mm;
            line-height: 1;
        }
        #label-total-value { font-size: 10pt; }

        /* --- COD TAG STYLES (UPDATED: Black Border Box with !important) --- */
        .cod-tag { 
            font-size: 7pt; 
            font-weight: 800; 
            color: #000; 
            background-color: #FFFFFF; 
            padding: 0.5mm 1mm;
            margin-top: 1mm; 
            /* Added Black Border with !important to force visibility */
            border: 1.5px solid #000 !important; 
            border-radius: 4px; 
            display: inline-block; 
            text-align: center;
        }

        .label-footer { 
            border-top: 1px dashed #000; 
            text-align: center; 
            font-size: 7pt; 
            font-weight: 700; 
            padding-top: 0.5mm; 
            margin-top: 0.5mm; 
            width: 100%; 
        }

        #qrcode img { margin: 0 auto; display: block; border: 1px solid #000; padding: 2px; background: white; }
        .qr-title { font-size: 11pt; font-weight: 800; margin-bottom: 2mm; text-transform: uppercase; }
        .qr-footer-box { 
            border: 1px solid #000; border-radius: 4px; padding: 1mm 4mm; margin-top: 2mm; font-weight: 700; font-size: 8pt; background-color: #fff;
            max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }

        /* PRINT STYLES */
        @page { size: var(--page-width) var(--page-height); margin: 0; }
        @media print {
            html, body { width: var(--page-width); height: var(--page-height); margin: 0 !important; padding: 0 !important; background: none !important; color: #000 !important; }
            #labels-wrapper { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .label-page { width: 100%; height: 100%; margin: 0 !important; border: none !important; box-shadow: none !important; overflow: hidden !important; page-break-after: always; color: #000 !important; }
            .total-box { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* Ensure COD border prints */
            .cod-tag { border: 1.5px solid #000 !important; } 
            .qr-footer-box { border: 1px solid #000 !important; }
            .hidden-on-print, .no-print, #styleEditor { display: none !important; }
            .info-block.right { border-left: 1px solid #000 !important; }
            /* Explicitly set header border for printing */
            .header-separator { background-color: #000 !important; height: 1.5px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
        body { background-color: #0f172a; padding: 2rem 1rem; }
        
        .editable-element { cursor: default; border: 1px solid transparent; transition: all 0.2s; }
        .design-mode-active .editable-element:hover { background-color: rgba(99, 102, 241, 0.2); outline: 1px dashed #6366f1; cursor: pointer; }
        .editable-element.selected { outline: 2px solid #6366f1; background-color: rgba(99, 102, 241, 0.1); }
        #styleEditor { position: fixed; bottom: -200px; left: 50%; transform: translateX(-50%); width: 300px; background: #1e293b; color: white; padding: 1rem; border-radius: 0.75rem; border: 1px solid #475569; transition: bottom 0.3s; z-index: 100; }
        .custom-input { background-color: #334155; border-color: #475569; color: white; }
    </style>
</head>
<body>

    <div class="no-print max-w-md mx-auto p-6 bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl mb-8">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-white mb-1">üñ®Ô∏è Label Printer</h1>
            <p class="text-sm text-slate-400">·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûü·üí·ûõ·û∂·ûÄ·ûä·ûπ·ûÄ·ûá·ûâ·üí·ûá·ûº·ûì (78mm x 50mm)</p>
        </div>

        <!-- Size Controls -->
        <div class="bg-slate-900/50 rounded-xl p-4 mb-4 border border-slate-700">
            <h2 class="text-sm font-bold text-slate-300 mb-3">·ûá·ûò·üí·ûö·ûæ·ûü·ûë·üÜ·û†·üÜ Label (mm)</h2>
            <div class="flex items-center gap-6">
                <label class="flex items-center cursor-pointer text-slate-300 text-sm"><input type="radio" name="label_size" value="standard" checked class="mr-2"> Standard (78x50)</label>
                <label class="flex items-center cursor-pointer text-slate-300 text-sm"><input type="radio" name="label_size" value="custom" class="mr-2"> Custom</label>
            </div>
            <div id="custom-size-inputs" class="hidden grid grid-cols-2 gap-3 mt-2">
                <input type="number" id="customWidth" value="78" class="custom-input w-full rounded p-2 text-xs">
                <input type="number" id="customHeight" value="50" class="custom-input w-full rounded p-2 text-xs">
            </div>
        </div>

        <!-- Margin Controls -->
        <div class="bg-slate-900/50 rounded-xl p-4 mb-4 border border-slate-700">
            <h2 class="text-sm font-bold text-slate-300 mb-3">·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã Margin (mm) - ·ûü·ûò·üí·ûö·û∂·ûî·üã Label ·ûñ·üê·ûè·üå·ûò·û∂·ûì</h2>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">·ûÅ·û∂·ûÑ·ûõ·ûæ (Top)</label>
                    <input type="number" id="marginTop" value="0" step="0.5" class="custom-input w-full rounded p-2 text-xs text-center">
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1">·ûÅ·û∂·ûÑ·ûÜ·üí·ûú·üÅ·ûÑ (Left)</label>
                    <input type="number" id="marginLeft" value="0" step="0.5" class="custom-input w-full rounded p-2 text-xs text-center">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">·ûÅ·û∂·ûÑ·ûÄ·üí·ûö·üÑ·ûò (Bottom)</label>
                    <input type="number" id="marginBottom" value="0" step="0.5" class="custom-input w-full rounded p-2 text-xs text-center">
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1">·ûÅ·û∂·ûÑ·ûü·üí·ûè·û∂·üÜ (Right)</label>
                    <input type="number" id="marginRight" value="0" step="0.5" class="custom-input w-full rounded p-2 text-xs text-center">
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 px-1">
            <label class="flex items-center cursor-pointer text-sm text-slate-300"><input type="checkbox" id="designModeToggle" class="mr-2"> ·ûÄ·üÇ·ûö·ûÖ·ûì·û∂·ûî·ûë</label>
            <button id="resetDesignButton" class="text-xs text-rose-400 underline">Reset</button>
        </div>

        <div class="flex flex-col gap-3">
            <button id="printButton" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                Print Label
            </button>
            <button id="printQRButton" class="hidden w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-4 rounded-xl shadow-md flex items-center justify-center gap-2">
                Print QR Map
            </button>
        </div>
    </div>

    <div id="labels-wrapper" class="flex flex-wrap justify-center gap-8 items-start mb-8 w-full">
        <!-- Main Label -->
        <div id="label-container" class="label-page">
            <div class="label-header editable-element" id="label-header-el">
                <!-- HEADER CONTENT -->
                <div class="flex items-center justify-center w-full overflow-hidden whitespace-nowrap">
                    <span id="header-store-group" class="flex items-center hidden">
                        Store: <span id="label-store">N/A</span>
                        <span class="mx-1">|</span>
                    </span>

                    ID:<span id="label-order-id">...</span>
                    
                    <span class="mx-1">|</span>
                    User:<span id="label-user">...</span>
                </div>
            </div>
            
            <!-- EXPLICIT SEPARATOR LINE -->
            <div class="header-separator"></div>

            <div class="info-row" id="info-row-el">
                <div class="info-block left">
                    <div class="small-text editable-element">·û¢·üí·ûì·ûÄ·ûë·ûë·ûΩ·ûõ / Recipient:</div>
                    <div id="label-name" class="big-text editable-element">...</div>
                    <div id="label-phone" class="mt-0.5 editable-element">...</div>

                    <div class="small-text compact-mt editable-element">·ûë·û∏·ûè·û∂·üÜ·ûÑ / Location:</div>
                    <div id="label-location" class="data-text editable-element">...</div>

                    <div class="small-text compact-mt editable-element">·û¢·û∂·ûü·ûô·ûä·üí·ûã·û∂·ûì / Address:</div>
                    <div id="label-address" class="data-text editable-element" style="overflow: hidden; max-height: 28px;">...</div>
                </div>

                <div class="info-block right">
                    <!-- Shop Name moved here with "Page:" prefix and left align -->
                    <div id="label-page-name" class="editable-element text-left">Page: Shop Name</div>

                    <div class="small-text compact-mt editable-element">·ûÄ·û∂·ûõ·ûî·ûö·û∑·ûÖ·üí·ûÜ·üÅ·ûë:</div>
                    <div id="label-date" class="data-text editable-element">...</div>

                    <div class="total-box" id="label-total-box">
                        ·ûè·ûò·üí·ûõ·üÉ: <span id="label-total-value" class="editable-element" data-id="label-total-value">$0.00</span>
                    </div>

                    <div class="small-text compact-mt editable-element">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ:</div>
                    <div id="label-payment" class="data-text font-bold editable-element">Unpaid</div>

                    <div class="small-text compact-mt editable-element">·ûä·ûπ·ûÄ·ûá·ûâ·üí·ûá·ûº·ûì:</div>
                    <div id="label-shipping" class="data-text editable-element">N/A</div>
                    
                    <div id="label-cod" class="cod-tag editable-element hidden">COD (Cash on Delivery)</div>
                </div>
            </div>

            <div class="label-footer editable-element" id="label-footer-el">·ûü·ûº·ûò·ûä·ûπ·ûÄ·ûá·ûâ·üí·ûá·ûº·ûì·ûä·üÑ·ûô·ûî·üí·ûö·ûª·ûÑ·ûî·üí·ûö·ûô·üê·ûè·üí·ûì!</div>
        </div>

        <!-- QR Code Label (Margins Disabled) -->
        <div id="qr-label-container" class="label-page hidden">
            <h2 class="qr-title editable-element" id="qr-title-el">·ûü·üí·ûÄ·üÅ·ûì·ûò·ûæ·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ</h2>
            <div id="qrcode"></div>
            <div class="qr-footer-box editable-element" id="qr-footer-el">Google Maps Link</div>
        </div>
    </div> 

    <div id="styleEditor" class="no-print">
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-bold text-slate-200">Edit Style</h4>
            <button id="closeEditor" class="text-slate-400">&times;</button>
        </div>
        <input type="number" id="editorFontSize" class="custom-input w-full p-2 rounded text-sm" placeholder="Font Size (pt)">
    </div>

    <audio id="audioWelcome" src="welcome.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. Parse URL Parameters
    const params = Object.fromEntries(new URLSearchParams(window.location.search).entries());
    const audioWelcome = document.getElementById('audioWelcome');

    // 2. Play Welcome Sound
    if (params.id) {
        const playWelcome = () => {
            audioWelcome.play().catch(e => console.log("Audio play failed:", e));
            document.removeEventListener('click', playWelcome);
        };
        document.addEventListener('click', playWelcome);
    }
    
    // --- 3. MAP & LINK DETECTION LOGIC ---
    let mapLink = params.map ? decodeURIComponent(params.map) : null;
    const note = params.note ? decodeURIComponent(params.note) : "";
    
    if (!mapLink || mapLink === "undefined" || mapLink === "null") {
        const fullTextSearch = (params.address || "") + " " + (params.location || "") + " " + note;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const matches = fullTextSearch.match(urlRegex);
        if (matches && matches.length > 0) mapLink = matches[0];
    }

    let addressDisplay = params.address || '';
    if (mapLink) {
        // Safe regex replacement for link
        try {
             const escapedLink = mapLink.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
             const linkRegex = new RegExp(escapedLink, 'g');
             addressDisplay = addressDisplay.replace(linkRegex, '').trim();
        } catch(e) {}
    }
    if (note) {
        let cleanNote = note;
        if (mapLink) {
             try {
                const escapedLink = mapLink.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                cleanNote = cleanNote.replace(new RegExp(escapedLink, 'g'), '').trim();
             } catch(e) {}
        }
        if (cleanNote) addressDisplay += ` (${decodeURIComponent(cleanNote)})`;
    }
    
    // ** IMPORTANT: Decode all text params to handle Khmer characters correctly **
    const safeDecode = (str) => {
        try { return decodeURIComponent(str || ''); } catch(e) { return str || ''; }
    };

    if (params.id) {
        // --- REAL DATA MODE ---
        document.getElementById('label-page-name').textContent = "Page: " + safeDecode(params.page || 'N/A');
        document.getElementById('label-user').textContent = safeDecode(params.user || 'N/A');
        document.getElementById('label-order-id').textContent = safeDecode(params.id || 'N/A');
        document.getElementById('label-name').textContent = safeDecode(params.name || 'N/A');
        document.getElementById('label-phone').textContent = safeDecode(params.phone || 'N/A');
        document.getElementById('label-location').textContent = safeDecode(params.location || 'N/A');
        
        document.getElementById('label-address').textContent = safeDecode(addressDisplay);
        
        document.getElementById('label-total-value').textContent = params.total ? `$${parseFloat(params.total).toFixed(2)}` : 'N/A';
        document.getElementById('label-payment').textContent = safeDecode(params.payment || 'Unpaid');
        document.getElementById('label-shipping').textContent = safeDecode(params.shipping || 'N/S');

        const storeName = safeDecode(params.store);
        const storeGroup = document.getElementById('header-store-group');
        const storeEl = document.getElementById('label-store');
        
        if (storeName && storeName !== 'Unknown' && storeName !== 'undefined') {
            storeEl.textContent = storeName;
            storeGroup.classList.remove('hidden');
        } else {
            storeGroup.classList.add('hidden');
        }

        // COD Logic
        const paymentVal = (params.payment || '').toLowerCase();
        const codEl = document.getElementById('label-cod');
        if (codEl) {
            if (paymentVal === 'unpaid' || paymentVal === 'cod') {
                codEl.classList.remove('hidden');
                codEl.textContent = 'COD (Cash on Delivery)';
            } else {
                codEl.classList.add('hidden');
            }
        }

        const today = new Date();
        document.getElementById('label-date').textContent = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
    } else {
         // --- MOCK DATA MODE (Testing without params) ---
        document.getElementById('label-page-name').textContent = "Page: ·û†·û∂·ûÑ·ûÇ·üÜ·ûö·ûº (Demo Shop)";
        document.getElementById('label-user').textContent = "Admin";
        document.getElementById('label-order-id').textContent = "DEMO-123";
        document.getElementById('label-name').textContent = "·û¢·ûè·û∑·ûê·û∑·ûá·ûì·ûÇ·üÜ·ûö·ûº";
        document.getElementById('label-phone').textContent = "012 345 678";
        document.getElementById('label-location').textContent = "·ûö·û∂·ûá·ûí·û∂·ûì·û∏·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ";
        document.getElementById('label-address').textContent = "·ûï·üí·ûë·üá·ûõ·üÅ·ûÅ ·ü°·ü¢·ü£, ·ûï·üí·ûõ·ûº·ûú ·ü§·ü•·ü¶, ·ûü·ûÑ·üí·ûÄ·û∂·ûè·üã·ûë·ûπ·ûÄ·ûõ·üí·û¢·ûÄ·üã";
        document.getElementById('label-total-value').textContent = "$25.00";
        document.getElementById('label-payment').textContent = "Unpaid";
        document.getElementById('label-shipping').textContent = "J&T Express";
        
        // Show Store in Header
        const storeGroup = document.getElementById('header-store-group');
        document.getElementById('label-store').textContent = "Store A";
        storeGroup.classList.remove('hidden');
        
        // Show COD in Mock Mode
        const codEl = document.getElementById('label-cod');
        codEl.classList.remove('hidden');
        
        // Date
        const today = new Date();
        document.getElementById('label-date').textContent = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
    }

    if (mapLink && mapLink !== "undefined" && mapLink !== "null") {
        document.getElementById('qr-label-container').classList.remove('hidden');
        document.getElementById('printQRButton').classList.remove('hidden');
        document.getElementById('printQRButton').classList.add('flex');
        
        // Construct Action URL
        // IMPORTANT: Ensure this points to the correct location of CustomerAction.html on your server
        const baseUrl = window.location.origin + "/CustomerAction.html"; 
        const actionUrl = `${baseUrl}?id=${encodeURIComponent(params.id || '')}&name=${encodeURIComponent(params.name || '')}&phone=${encodeURIComponent(params.phone || '')}&map=${encodeURIComponent(mapLink)}`;

        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = "";
        
        new QRCode(qrDiv, {
            text: actionUrl, 
            width: 100, 
            height: 100,
            colorDark : "#000000", 
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.M
        });
    }

    function printSpecificLabel(id) {
        document.querySelectorAll('.label-page').forEach(l => {
            if (l.id !== id) l.classList.add('hidden-on-print');
            else l.classList.remove('hidden-on-print');
        });
        window.print();
        document.querySelectorAll('.label-page').forEach(l => l.classList.remove('hidden-on-print'));
    }

    document.getElementById('printButton').addEventListener('click', () => printSpecificLabel('label-container'));
    document.getElementById('printQRButton').addEventListener('click', () => printSpecificLabel('qr-label-container'));

    // --- MARGIN CONTROL LOGIC ---
    const marginTopInput = document.getElementById('marginTop');
    const marginLeftInput = document.getElementById('marginLeft');
    const marginBottomInput = document.getElementById('marginBottom');
    const marginRightInput = document.getElementById('marginRight');

    const savedMarginTop = localStorage.getItem('label_margin_top') || '0';
    const savedMarginLeft = localStorage.getItem('label_margin_left') || '0';
    const savedMarginBottom = localStorage.getItem('label_margin_bottom') || '0';
    const savedMarginRight = localStorage.getItem('label_margin_right') || '0';
    
    marginTopInput.value = savedMarginTop;
    marginLeftInput.value = savedMarginLeft;
    marginBottomInput.value = savedMarginBottom;
    marginRightInput.value = savedMarginRight;
    
    function updateRootVars() {
        const root = document.documentElement;
        const mt = marginTopInput.value || 0;
        const ml = marginLeftInput.value || 0;
        const mb = marginBottomInput.value || 0;
        const mr = marginRightInput.value || 0;

        root.style.setProperty('--page-margin-top', mt + 'mm');
        root.style.setProperty('--page-margin-left', ml + 'mm');
        root.style.setProperty('--page-margin-bottom', mb + 'mm');
        root.style.setProperty('--page-margin-right', mr + 'mm');
        
        localStorage.setItem('label_margin_top', mt);
        localStorage.setItem('label_margin_left', ml);
        localStorage.setItem('label_margin_bottom', mb);
        localStorage.setItem('label_margin_right', mr);
    }
    
    updateRootVars();

    marginTopInput.addEventListener('input', updateRootVars);
    marginLeftInput.addEventListener('input', updateRootVars);
    marginBottomInput.addEventListener('input', updateRootVars);
    marginRightInput.addEventListener('input', updateRootVars);

    // --- DESIGN MODE LOGIC ---
    const designToggle = document.getElementById('designModeToggle');
    const editor = document.getElementById('styleEditor');
    const editorInput = document.getElementById('editorFontSize');
    let selectedEl = null;

    designToggle.addEventListener('change', (e) => {
        const active = e.target.checked;
        document.querySelectorAll('.label-page').forEach(c => active ? c.classList.add('design-mode-active') : c.classList.remove('design-mode-active'));
        if (!active) editor.style.bottom = '-200px';
    });

    document.querySelectorAll('.editable-element').forEach(el => {
        el.addEventListener('click', (ev) => {
            if (!designToggle.checked) return;
            selectedEl = el;
            document.querySelectorAll('.selected').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            editor.style.bottom = '20px';
            editorInput.value = parseFloat(window.getComputedStyle(el).fontSize);
            ev.stopPropagation();
        });
    });

    editorInput.addEventListener('input', (e) => {
        if (selectedEl) {
            selectedEl.style.fontSize = e.target.value + 'pt';
            localStorage.setItem('style_' + selectedEl.id, e.target.value);
        }
    });

    document.getElementById('closeEditor').addEventListener('click', () => editor.style.bottom = '-200px');
    document.getElementById('resetDesignButton').addEventListener('click', () => {
        if(confirm('Reset all styles and margins?')) { localStorage.clear(); location.reload(); }
    });

    document.querySelectorAll('.editable-element').forEach(el => {
        const saved = localStorage.getItem('style_' + el.id);
        if (saved) el.style.fontSize = saved + 'pt';
    });
});
</script>
</body>
</html>
